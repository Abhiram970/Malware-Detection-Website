from django.shortcuts import render
from django.core.files.storage import FileSystemStorage
# Create your views here.
import tensorflow as tf
from keras.models import load_model
from keras.utils.image_utils import load_img , img_to_array



model = load_model('./models/malimg.h5')
list_of_mal = ["Adialer.C","Agent.FYI","Allaple.A","Allaple.L","Alueron.gen!J","Autorun.K","C2LOP.P","C2LOP.gen!g","Dialplatform.B","Dontovo.A","Fakerean","Instantaccess","Lolyda.AA1","Lolyda.AA2","Lolyda.AA3","Lolyda.AT","Malex.gen!J","Obfuscator.AD","Rbot!gen","Skintrim.N","Swizzor.gen!E","Swizzor.gen!I","VB.AT","Wintrim.BX","Yuner.A"]

def index(request):
    context = {'a' : 1}
    return render(request,'index.html',context)




def predictImage(request):
    print(request.POST.dict())
    print(request.FILES['filePath'])
    fileObj = request.FILES['filePath']
    fs = FileSystemStorage()
    filePathName = fs.save(fileObj.name,fileObj)
    filePathName = fs.url(filePathName)
    testimage = '.' + filePathName
    img = load_img(testimage,target_size = (64,64))
    x = img_to_array(img)
    x = x/255
    x = x.reshape(1,64,64,3)
    prediction = model.predict(x)
    final_l = prediction[0]
    final_list = final_l.tolist()
    max = -100
    index = -1
    for i in range(len(final_list)):
        if (int(final_list[i]) > max):
            max = final_list[i]
            index = i
    print(prediction)
    predictedLabel = "The final malware detected is " + list_of_mal[index]
    context = {'filePathName' : filePathName , 'predictedLabel' : predictedLabel}
    return render(request,'index.html',context)